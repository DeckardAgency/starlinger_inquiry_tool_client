<!-- src/app/shop/shop.component.html -->
<div class="shop">
  <app-breadcrumbs [items]="breadcrumbs"></app-breadcrumbs>

  <div class="shop__header">
    <div class="shop__header-left">
      <h1 class="shop__title">Availible parts
        <span class="shop__title--total-items" *ngIf="!loading">{{ totalItems }}</span>
        <span class="shop__title--total-items shimmer-effect" *ngIf="loading"></span>
      </h1>
    </div>

    <div class="shop__header-right">
      <div class="shop__controls">
        <div class="shop__view-controls">
          <button
            class="shop__view-btn shop__view-btn--disabled"
            [class.active]="viewMode === 'grid'"
            (click)="viewMode = 'grid'"
          >
            <span class="material-icons">
              <app-icon name="grid" size="16px" color="#232323"></app-icon>
            </span>
            Grid view
          </button>
          <button
            class="shop__view-btn"
            [class.active]="viewMode === 'list'"
            (click)="viewMode = 'list'"
          >
            <span class="material-icons">
              <app-icon name="list" size="16px" color="#232323"></app-icon>
            </span>
            List view
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="shop__filters">
    <div class="shop__search">
        <span class="material-icons">
          <app-icon name="magnifier" size="16px" color="#71717A"></app-icon>
        </span>
      <input
        type="text"
        [formControl]="searchControl"
        placeholder="Filter by part number"
        class="shop__search-input"
      >
    </div>

    <div class="shop__machine-filter">
      <button class="shop__filter-btn" (click)="toggleFilter()">
        <span class="material-icons">
          <app-icon name="filter" size="16px" color="#232323 "></app-icon>
        </span>
        Filter by machine
        <app-icon name="arrowDown" size="16px" color="#232323 "></app-icon>
      </button>

      @if (isFilterOpen) {
        <div class="shop__filter-dropdown">
          @for (machine of machines; track machine.id) {
            <label class="shop__filter-option">
              <input
                type="checkbox"
                [checked]="machine.checked"
                (change)="toggleMachine(machine)"
              >
              <span class="shop__filter-checkbox"></span>
              <span class="shop__filter-label">{{ machine.name }}</span>
            </label>
          }
        </div>
      }

    </div>
  </div>

  @if (activeFilters.length > 0) {
    <div class="shop__active-filters">
      <span>Active filters:</span>
      @for (filter of activeFilters; track filter) {
        <div class="shop__filter-tag">
          {{ filter }}
          <button class="shop__filter-remove" (click)="removeFilter(filter)">
            <span class="material-icons">
              <app-icon name="close" size="16px" color="#71717A  "></app-icon>
            </span>
          </button>
        </div>
      }
    </div>
  }

  <!-- Grid View with Full Page Details -->
  @if (viewMode === 'grid' && selectedProduct) {
    <div class="shop__details shop__details--full">
      <div class="shop__details-header">
        <button class="shop__back-btn" (click)="closeDetails()">
          <span class="material-icons">
            <svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 12 6 8l4-4" stroke="#232323" stroke-width="1.33" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
        </button>
        <h2 class="shop__details-title">Product details</h2>
        <button class="shop__wishlist-btn">
          <span class="material-icons">
            <svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.333 8h9.334M8 3.333v9.334" stroke="#232323" stroke-width="1.33" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
          Add to Wishlist
        </button>
      </div>

      <div class="shop__details-content">
        <div class="shop__details-image">
          <img src="https://via.assets.so/img.jpg?w=600&h=400" alt="Product detail image" loading="lazy">
        </div>

        <div class="shop__details-info">
          <div class="shop__details-specs">
            <div class="shop__spec-item">
              <span class="material-icons">sell</span>
              <div class="shop__spec-content">
                <span class="shop__spec-label">Part no.</span>
                <span class="shop__spec-value">{{ selectedProduct.partNo }}</span>
              </div>
            </div>
            <div class="shop__spec-item">
              <span class="material-icons">analytics</span>
              <div class="shop__spec-content">
                <span class="shop__spec-label">Statistic</span>
                <span class="shop__spec-value">ET</span>
              </div>
            </div>
            <div class="shop__spec-item">
              <span class="material-icons">scale</span>
              <div class="shop__spec-content">
                <span class="shop__spec-label">Weight</span>
                <span class="shop__spec-value">0.4 kg</span>
              </div>
            </div>
          </div>

          <h1 class="shop__details-name">{{ selectedProduct.name }}</h1>

          <p class="shop__details-description">{{ selectedProduct.shortDescription }}</p>

          @if (selectedProduct.clientPrice > 0) {
            <div class="shop__details-price">
              <span class="shop__original-price">€ {{ selectedProduct.clientPrice }}</span>
              <span class="shop__discount">-20%</span>
              <span class="shop__final-price">€ {{ selectedProduct.clientPrice * 0.8 }}</span>
            </div>
          }

          <div class="shop__details-machine">
            <span class="material-icons">precision_manufacturing</span>
            <div class="shop__machine-info">
              <span class="shop__machine-label">Machine</span>
              <span class="shop__machine-value">{{ selectedProduct.name }}</span>
            </div>
          </div>

          <div class="shop__details-tech">
            <span class="material-icons">settings</span>
            <div class="shop__tech-info">
              <span class="shop__tech-label">Technical description</span>
              <span class="shop__tech-value">{{ selectedProduct.technicalDescription }}</span>
            </div>
          </div>

          <div class="shop__details-actions">
            <div class="shop__quantity">
              <button class="shop__quantity-btn" (click)="decrementQuantity()">−</button>
              <input type="number" [formControl]="quantityControl" class="shop__quantity-input">
              <button class="shop__quantity-btn" (click)="incrementQuantity()">+</button>
            </div>
            <button class="shop__add-cart" (click)="addSelectedProductToCart()">
              Add to Cart
              <span class="material-icons">arrow_forward</span>
            </button>
          </div>
        </div>

        <!-- Related Products Section -->
        <div class="shop__related">
          <h3 class="shop__related-title">Related products</h3>
          <div class="shop__related-grid">
            @for (product of relatedProducts; track product.id) {
              <app-article-item
                [product]="product"
                viewMode="grid"
                (productSelected)="selectProduct($event)"
              ></app-article-item>
            }
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Normal List/Grid View -->
  @if (!selectedProduct || viewMode === 'list') {
    <div class="shop__container"
         [class.shop__container--list]="viewMode === 'list'"
         [class.shop__container--grid-details]="viewMode === 'grid' && selectedProduct">

      <div class="shop__products-section"
           [class.shop__products-section--details]="selectedProduct"
           [class.shop__products-section--hidden]="viewMode === 'grid' && selectedProduct">


        @if (loading) {
          <div class="shop__products shop__products--list">
            <app-article-item-shimmer *ngFor="let i of [1,2,3,4,5,6,7,8,9]"></app-article-item-shimmer>
          </div>
        }

        @if (error) {
          <div class="shop__error">{{ error }}</div>
        }

        @if (!loading && !error) {
          <div
            class="shop__products"
            [class.shop__products--grid]="viewMode === 'grid'"
            [class.shop__products--list]="viewMode === 'list'"
          >
            @for (product of filteredProducts; track product.id) {
              <app-article-item
                [product]="product"
                [viewMode]="viewMode"
                [isSelected]="selectedProduct?.id === product.id"
                (productSelected)="selectProduct($event)"
              ></app-article-item>
            }
          </div>
        }
      </div>

      @if (selectedProduct && viewMode === 'list') {
        <div class="product-details">
          <div class="shop__details">
            <div class="shop__details-header">
              <button class="shop__back-btn" (click)="closeDetails()">
                  <span class="material-icons">
                    <app-icon name="packageSearch" size="24px" color="#232323"></app-icon>
                  </span>
              </button>
              <h2 class="shop__details-title">Product details</h2>
              <button class="shop__wishlist-btn">
                  <span class="material-icons">
                    <app-icon name="plus" size="16px" color="#232323"></app-icon>
                  </span>
                Add to Wishlist
              </button>
            </div>
          </div>

          <div>
            @if (selectedProduct) {
              <app-product-card [product]="selectedProduct"></app-product-card>
            }
          </div>
        </div>
      }
    </div>
  }
</div>
